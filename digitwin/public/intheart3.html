<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DrugSim - Interactive Digital Twin</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "three": "https://esm.sh/three@0.160.0",
                "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.16?external=react,react-dom,three",
                "@react-three/drei": "https://esm.sh/@react-three/drei@9.99.0?external=react,react-dom,three,@react-three/fiber",
                "uuid": "https://esm.sh/uuid@9.0.1"
            }
        }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            margin: 0;
            background-color: #050505;
            color: white;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useMemo, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as THREE from 'three';
        import { Canvas, useFrame, useThree } from '@react-three/fiber';
        import { OrbitControls, Environment, useGLTF, ContactShadows } from '@react-three/drei';

        // --- ICONS ---
        const IconActivity = () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2" /></svg>;
        const IconHeart = () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /></svg>;
        const IconWind = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2" /><path d="M9.6 4.6A2 2 0 1 1 11 8H2" /><path d="M12.6 19.4A2 2 0 1 0 14 16H2" /></svg>;

        // --- DATA ---
        const DRUG_DATA = {
            metoprolol: { name: "Metoprolol", type: "Beta-blocker", desc: "Slows heart rate (Blue Glow).", effect: { hr: -0.8, flow: -0.5, contractility: -0.4 }, color: "#0088ff" },
            enalapril: { name: "Enalapril", type: "ACE Inhibitor", desc: "Lowers pressure (Green Glow).", effect: { hr: -0.1, flow: 0.8, contractility: 0.1 }, color: "#00ff88" },
            atropine: { name: "Atropine", type: "Anticholinergic", desc: "Rapid Heart Rate (Red Glow).", effect: { hr: 2.5, flow: 1.2, contractility: 0.8 }, color: "#ff0000" },
            hydrochlorothiazide: { name: "Hydrochlorothiazide", type: "Diuretic", desc: "Reduces volume (Orange Glow).", effect: { hr: 0.0, flow: -0.9, contractility: -0.1 }, color: "#ffaa00" }
        };
        const BASE_STATS = { bpm: 75, pressure: 120, flow: 5.0 };

        // --- IMPROVED 3D HEART COMPONENT ---
        const RealisticHeart = ({ simulationState }) => {
            const groupRef = useRef();
            const { scene } = useThree();
            const gltf = useGLTF('./heart.glb', true);

            useFrame((state) => {
                if (!groupRef.current) return;
                const time = state.clock.getElapsedTime();
                const frequency = simulationState.bpm / 60;
                const beat = Math.sin(time * frequency * Math.PI * 2);

                // --- SCALE LOGIC (BIGGER) ---
                const baseScale = 2.2;
                const amplitude = 0.2 + (simulationState.contractilityFactor * 0.05);
                const currentScale = baseScale + (beat * amplitude);

                groupRef.current.scale.set(currentScale, currentScale, currentScale);
            });

            // Material Update Logic
            useEffect(() => {
                if (!gltf.scene) return;
                gltf.scene.traverse((child) => {
                    if (child.isMesh) {
                        child.material.roughness = 0.3;
                        child.material.metalness = 0.1;
                        child.material.emissive = new THREE.Color(simulationState.color);
                        child.material.emissiveIntensity = 0.5;
                        child.material.needsUpdate = true;
                    }
                });
            }, [gltf.scene, simulationState.color]);

            // --- POSITION LOGIC (CENTERED) ---
            return (
                <group ref={groupRef} position={[0, -0.5, 0]}>
                    <primitive object={gltf.scene} />
                </group>
            );
        };

        // --- RESULTS PANEL COMPONENT ---
        const ResultsPanel = ({ results, onClose }) => {
            if (!results) return null;

            return (
                <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-8">
                    <div className="bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto flex flex-col">
                        <div className="p-6 border-b border-gray-800 flex justify-between items-center sticky top-0 bg-gray-900 z-10">
                            <div>
                                <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                                    <IconActivity /> Simulation Results
                                </h2>
                                <p className="text-blue-400 text-sm mt-1">PK/PD Model Output</p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-gray-800 rounded-lg text-gray-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>

                        <div className="p-8 space-y-8">
                            {/* Summary Stats 
                            //  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            //      <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                            //          <p className="text-gray-400 text-xs uppercase font-bold">Max Concentration</p>
                            //          <p className="text-2xl font-mono font-bold text-blue-400 mt-1">
                            //              145.20 <span className="text-sm text-gray-500">ng/mL</span>
                            //          </p>
                            //      </div>
                            //      <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                            //          <p className="text-gray-400 text-xs uppercase font-bold">Max Effect</p>
                            //          <p className="text-2xl font-mono font-bold text-green-400 mt-1">
                            //              -12.5 <span className="text-sm text-gray-500">%</span>
                            //          </p>
                            //      </div>
                            //      <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                            //          <p className="text-gray-400 text-xs uppercase font-bold">Duration</p>
                            //          <p className="text-2xl font-mono font-bold text-purple-400 mt-1">
                            //              {results.time[results.time.length - 1]} <span className="text-sm text-gray-500">hrs</span>
                            //          </p>
                            //     </div>
                            //  </div>*/}

                            {/* Graphs */}
                            <div className="space-y-6">
                                {results.images ? (
                                    <div className="grid grid-cols-1 gap-6">
                                        <div className="bg-gray-800/30 p-4 rounded-xl border border-gray-700">
                                            <h3 className="text-lg font-bold text-white mb-4">PK Concentration</h3>
                                            <img src={`http://localhost:8001/static/${results.images.pk}`} alt="PK Concentration" className="w-full rounded-lg" />
                                        </div>
                                        <div className="bg-gray-800/30 p-4 rounded-xl border border-gray-700">
                                            <h3 className="text-lg font-bold text-white mb-4">Heart Rate</h3>
                                            <img src={`http://localhost:8001/static/${results.images.hr}`} alt="Heart Rate" className="w-full rounded-lg" />
                                        </div>
                                        <div className="bg-gray-800/30 p-4 rounded-xl border border-gray-700">
                                            <h3 className="text-lg font-bold text-white mb-4">Blood Pressure</h3>
                                            <img src={`http://localhost:8001/static/${results.images.bp}`} alt="Blood Pressure" className="w-full rounded-lg" />
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        <div>
                                            <h3 className="text-lg font-bold text-white mb-4">Concentration vs Time</h3>
                                            <div className="h-48 flex items-end gap-1 bg-gray-800/30 p-4 rounded-xl border border-gray-700 overflow-hidden">
                                                {results.concentration.map((val, i) => (
                                                    <div key={i} style={{ height: `${(val / Math.max(...results.concentration)) * 100}%` }} className="flex-1 bg-blue-500/50 hover:bg-blue-400 transition-colors rounded-t-sm"></div>
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <h3 className="text-lg font-bold text-white mb-4">Effect vs Time</h3>
                                            <div className="h-48 flex items-end gap-1 bg-gray-800/30 p-4 rounded-xl border border-gray-700 overflow-hidden">
                                                {results.effect.map((val, i) => (
                                                    <div key={i} style={{ height: `${(val / Math.max(...results.effect)) * 100}%` }} className="flex-1 bg-green-500/50 hover:bg-green-400 transition-colors rounded-t-sm"></div>
                                                ))}
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [selectedDrug, setSelectedDrug] = useState('metoprolol');
            const [dosage, setDosage] = useState(10);
            const [simulationResults, setSimulationResults] = useState(null);

            // Patient Parameters State - Only Vitals now
            const [hr, setHr] = useState(75);
            const [sbp, setSbp] = useState(120);
            const [dbp, setDbp] = useState(80);

            useEffect(() => {
                const handleMessage = (event) => {
                    if (event.data && event.data.type === 'SIMULATION_COMPLETE') {
                        console.log("Simulation results received:", event.data.result);
                        setSimulationResults(event.data.result);
                    }
                };
                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, []);

            const simulationState = useMemo(() => {
                const baseColor = "#550000";
                const drug = DRUG_DATA[selectedDrug];
                const hrEffect = (dosage * drug.effect.hr);
                const newBpm = Math.max(30, BASE_STATS.bpm + hrEffect);
                const flowEffect = (dosage * 0.1 * drug.effect.flow);
                const newFlow = Math.max(1, BASE_STATS.flow + flowEffect);
                const activeColor = dosage > 0 ? drug.color : baseColor;

                return {
                    bpm: Math.round(newBpm),
                    flow: newFlow.toFixed(1),
                    contractilityFactor: 1 + (dosage * 0.02),
                    color: activeColor
                };
            }, [selectedDrug, dosage]);

            return (
                <div className="flex h-screen w-full bg-black text-white font-sans overflow-hidden relative">
                    {simulationResults && <ResultsPanel results={simulationResults} onClose={() => setSimulationResults(null)} />}

                    {/* LEFT: 3D VIEWER + TITLE */}
                    <div className="flex-1 relative bg-gradient-to-b from-gray-900 to-black">

                        {/* TITLE - BLUE COLOR */}
                        <div className="absolute top-8 left-20 z-30 pointer-events-none">
                            <h1 className="text-4xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-400 drop-shadow-lg flex items-center gap-4">
                                <IconHeart /> DrugSim
                            </h1>
                            <p className="text-sm text-blue-200/60 mt-2 font-light tracking-wide ml-2">Interactive Pharmacological Digital Twin</p>
                        </div>

                        {/* STATS OVERLAY */}
                        <div className="absolute bottom-10 left-8 z-20 bg-gray-900/80 p-6 rounded-2xl border border-gray-600 shadow-2xl w-80 backdrop-blur-md">
                            <h2 className="text-lg font-bold flex items-center gap-3 mb-4 text-white border-b border-gray-600 pb-2">
                                <span className="text-blue-500 animate-pulse"><IconActivity /></span> Live Telemetry
                            </h2>
                            <div className="space-y-6">
                                <div>
                                    <p className="text-gray-400 text-xs uppercase tracking-widest font-bold">Heart Rate</p>
                                    <p className="text-3xl font-mono font-bold text-white mt-1">
                                        {simulationState.bpm} <span className="text-sm text-gray-500 font-sans">BPM</span>
                                    </p>
                                </div>
                                <div>
                                    <p className="text-gray-400 text-xs uppercase tracking-widest font-bold">Cardiac Output</p>
                                    <p className="text-3xl font-mono font-bold text-blue-400 mt-1">
                                        {simulationState.flow} <span className="text-sm text-gray-500 font-sans">L/min</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <Canvas camera={{ position: [0, 0, 5], fov: 40 }} shadows>
                            <fog attach="fog" args={['#000000', 5, 25]} />
                            <ambientLight intensity={2.0} />
                            <directionalLight position={[5, 5, 5]} intensity={4} castShadow />
                            <pointLight position={[-5, 2, -5]} intensity={3} color="#44aadd" />
                            <pointLight position={[5, -2, -5]} intensity={3} color="#ffaa44" />

                            <React.Suspense fallback={null}>
                                <RealisticHeart simulationState={simulationState} />
                                <ContactShadows position={[0, -2.5, 0]} opacity={0.75} scale={10} blur={2.5} far={4} />
                            </React.Suspense>

                            <Environment preset="city" />
                            <OrbitControls minDistance={3} maxDistance={9} />
                        </Canvas>
                    </div>

                    {/* RIGHT: SIDEBAR CONTROLS */}
                    <div className="w-[450px] bg-gray-900 shadow-2xl flex flex-col border-l border-gray-700 z-40">
                        <div className="p-8 border-b border-gray-800 bg-gray-800/50">
                            <h2 className="text-lg font-bold text-blue-400 mb-1">Configuration</h2>
                            <p className="text-gray-400 text-sm">Adjust parameters below</p>
                        </div>

                        <div className="p-8 flex-1 overflow-y-auto space-y-8">

                            {/* PATIENT PARAMETERS (Sliders) */}
                            <div className="space-y-6">
                                <h3 className="text-gray-300 text-xs uppercase font-bold tracking-wider border-b border-gray-700 pb-2">Patient Vitals</h3>

                                {/* Heart Rate Slider */}
                                <div>
                                    <div className="flex justify-between mb-2">
                                        <label className="text-gray-400 text-xs">Heart Rate</label>
                                        <span className="text-blue-400 font-mono text-sm">{hr} bpm</span>
                                    </div>
                                    <input
                                        type="range" min="40" max="180" step="1"
                                        value={hr}
                                        onChange={(e) => setHr(Number(e.target.value))}
                                        className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                    />
                                </div>

                                {/* SBP Slider */}
                                <div>
                                    <div className="flex justify-between mb-2">
                                        <label className="text-gray-400 text-xs">Systolic BP</label>
                                        <span className="text-blue-400 font-mono text-sm">{sbp} mmHg</span>
                                    </div>
                                    <input
                                        type="range" min="80" max="200" step="1"
                                        value={sbp}
                                        onChange={(e) => setSbp(Number(e.target.value))}
                                        className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                    />
                                </div>

                                {/* DBP Slider */}
                                <div>
                                    <div className="flex justify-between mb-2">
                                        <label className="text-gray-400 text-xs">Diastolic BP</label>
                                        <span className="text-blue-400 font-mono text-sm">{dbp} mmHg</span>
                                    </div>
                                    <input
                                        type="range" min="40" max="120" step="1"
                                        value={dbp}
                                        onChange={(e) => setDbp(Number(e.target.value))}
                                        className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                    />
                                </div>
                            </div>

                            {/* DRUG SELECTOR */}
                            <div className="space-y-3">
                                <label className="block text-gray-300 text-xs uppercase font-bold tracking-wider">Select Agent</label>
                                <div className="relative">
                                    <select
                                        value={selectedDrug}
                                        onChange={(e) => setSelectedDrug(e.target.value)}
                                        className="w-full bg-gray-800 border-2 border-gray-600 rounded-xl p-3 text-sm text-white focus:border-blue-500 outline-none appearance-none cursor-pointer hover:bg-gray-750 transition-colors"
                                    >
                                        {Object.keys(DRUG_DATA).map((key) => (<option key={key} value={key}>{DRUG_DATA[key].name}</option>))}
                                    </select>
                                    <div className="absolute right-4 top-4 pointer-events-none text-gray-400 text-xs">â–¼</div>
                                </div>
                                <div className="p-4 rounded-xl bg-gray-800/50 border border-gray-700">
                                    <p className="text-sm" style={{ color: DRUG_DATA[selectedDrug].color }}>
                                        <span className="font-bold">Effect:</span> {DRUG_DATA[selectedDrug].desc}
                                    </p>
                                </div>
                            </div>

                            {/* DOSAGE SLIDER */}
                            <div className="space-y-4">
                                <div className="flex justify-between items-end">
                                    <label className="text-gray-300 text-xs uppercase font-bold tracking-wider">Dosage (mg)</label>
                                    <span className="font-mono text-lg font-bold text-blue-400 bg-blue-900/30 px-3 py-1 rounded-lg border border-blue-500/30">{dosage} mg</span>
                                </div>
                                <input
                                    type="range" min="0" max="100" step="1"
                                    value={dosage}
                                    onChange={(e) => setDosage(Number(e.target.value))}
                                    className="w-full h-4 bg-gray-700 rounded-full appearance-none cursor-pointer accent-blue-500 hover:accent-blue-400"
                                />
                                <div className="flex justify-between text-gray-500 text-xs font-semibold">
                                    <span>0mg</span>
                                    <span>50mg</span>
                                    <span>100mg (Toxic)</span>
                                </div>
                            </div>

                            {/* INFO BOX */}
                            <div className="bg-blue-900/10 border border-blue-500/20 p-6 rounded-xl">
                                <h3 className="text-blue-400 font-bold mb-2 flex items-center gap-2 text-sm">
                                    <IconWind /> Simulation Active
                                </h3>
                                <p className="text-gray-400 text-xs leading-relaxed">
                                    The digital twin is currently responding to the selected pharmacological agent. Observe the heart rate frequency and color shift in the 3D model.
                                </p>
                            </div>

                            {/* SIMULATE BUTTON */}
                            <button
                                onClick={() => {
                                    console.log("ðŸ–±ï¸ Simulate button clicked!");
                                    // alert("Button clicked! Sending message...");
                                    try {
                                        window.parent.postMessage({
                                            type: 'SIMULATE_DRUG',
                                            data: {
                                                drug: selectedDrug,
                                                dosage: dosage,
                                                // Patient Params (Vitals only)
                                                hr, sbp, dbp
                                            }
                                        }, '*');
                                        console.log("ðŸ“¤ Message sent to parent.");
                                    } catch (e) {
                                        console.error("âŒ Error sending message:", e);
                                        alert("Error sending message: " + e.message);
                                    }
                                }}
                                className="w-full py-4 bg-gradient-to-r from-blue-600 to-cyan-500 rounded-xl font-bold text-white shadow-lg hover:shadow-blue-500/25 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-2 uppercase tracking-wider text-sm"
                            >
                                <IconActivity /> Simulate Drug
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
const groupRef = useRef();
const { scene } = useThree();
const gltf = useGLTF('./heart.glb', true);

useFrame((state) => {
if (!groupRef.current) return;
<p className="text-gray-400 text-xs uppercase tracking-widest font-bold">Heart Rate</p>
<p className="text-3xl font-mono font-bold text-white mt-1">
    {simulationState.bpm} <span className="text-sm text-gray-500 font-sans">BPM</span>
</p>
</div>
<div>
    <p className="text-gray-400 text-xs uppercase tracking-widest font-bold">Cardiac Output</p>
    <p className="text-3xl font-mono font-bold text-blue-400 mt-1">
        {simulationState.flow} <span className="text-sm text-gray-500 font-sans">L/min</span>
    </p>
</div>
</div>
</div>

<Canvas camera={{ position: [0, 0, 5], fov: 40 }} shadows>
    <fog attach="fog" args={['#000000', 5, 25]} />
    <ambientLight intensity={2.0} />
    <directionalLight position={[5, 5, 5]} intensity={4} castShadow />
    <pointLight position={[-5, 2, -5]} intensity={3} color="#44aadd" />
    <pointLight position={[5, -2, -5]} intensity={3} color="#ffaa44" />

    <React.Suspense fallback={null}>
        <RealisticHeart simulationState={simulationState} />
        <ContactShadows position={[0, -2.5, 0]} opacity={0.75} scale={10} blur={2.5} far={4} />
    </React.Suspense>

    <Environment preset="city" />
    <OrbitControls minDistance={3} maxDistance={9} />
</Canvas>
</div>

{/* RIGHT: SIDEBAR CONTROLS */ }
< div className="w-[450px] bg-gray-900 shadow-2xl flex flex-col border-l border-gray-700 z-40">
    <div className="p-8 border-b border-gray-800 bg-gray-800/50">
        <h2 className="text-lg font-bold text-blue-400 mb-1">Configuration</h2>
        <p className="text-gray-400 text-sm">Adjust parameters below</p>
    </div>

    <div className="p-8 flex-1 overflow-y-auto space-y-8">

        {/* PATIENT PARAMETERS (Sliders) */}
        <div className="space-y-6">
            <h3 className="text-gray-300 text-xs uppercase font-bold tracking-wider border-b border-gray-700 pb-2">
                Patient Vitals</h3>

            {/* Heart Rate Slider */}
            <div>
                <div className="flex justify-between mb-2">
                    <label className="text-gray-400 text-xs">Heart Rate</label>
                    <span className="text-blue-400 font-mono text-sm">{hr} bpm</span>
                </div>
                <input type="range" min="40" max="180" step="1" value={hr} onChange={(e)=>
                setHr(Number(e.target.value))}
                className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                />
            </div>

            {/* SBP Slider */}
            <div>
                <div className="flex justify-between mb-2">
                    <label className="text-gray-400 text-xs">Systolic BP</label>
                    <span className="text-blue-400 font-mono text-sm">{sbp} mmHg</span>
                </div>
                <input type="range" min="80" max="200" step="1" value={sbp} onChange={(e)=>
                setSbp(Number(e.target.value))}
                className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                />
            </div>

            {/* DBP Slider */}
            <div>
                <div className="flex justify-between mb-2">
                    <label className="text-gray-400 text-xs">Diastolic BP</label>
                    <span className="text-blue-400 font-mono text-sm">{dbp} mmHg</span>
                </div>
                <input type="range" min="40" max="120" step="1" value={dbp} onChange={(e)=>
                setDbp(Number(e.target.value))}
                className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                />
            </div>
        </div>

        {/* DRUG SELECTOR */}
        <div className="space-y-3">
            <label className="block text-gray-300 text-xs uppercase font-bold tracking-wider">Select Agent</label>
            <div className="relative">
                <select value={selectedDrug} onChange={(e)=> setSelectedDrug(e.target.value)}
                    className="w-full bg-gray-800 border-2 border-gray-600 rounded-xl p-3 text-sm text-white
                    focus:border-blue-500 outline-none appearance-none cursor-pointer hover:bg-gray-750
                    transition-colors"
                    >
                    {Object.keys(DRUG_DATA).map((key) => (<option key={key} value={key}>{DRUG_DATA[key].name}</option>
                    ))}
                </select>
                <div className="absolute right-4 top-4 pointer-events-none text-gray-400 text-xs">â–¼</div>
            </div>
            <div className="p-4 rounded-xl bg-gray-800/50 border border-gray-700">
                <p className="text-sm" style={{ color: DRUG_DATA[selectedDrug].color }}>
                    <span className="font-bold">Effect:</span> {DRUG_DATA[selectedDrug].desc}
                </p>
            </div>
        </div>

        {/* DOSAGE SLIDER */}
        <div className="space-y-4">
            <div className="flex justify-between items-end">
                <label className="text-gray-300 text-xs uppercase font-bold tracking-wider">Dosage (mg)</label>
                <span
                    className="font-mono text-lg font-bold text-blue-400 bg-blue-900/30 px-3 py-1 rounded-lg border border-blue-500/30">{dosage}
                    mg</span>
            </div>
            <input type="range" min="0" max="100" step="1" value={dosage} onChange={(e)=>
            setDosage(Number(e.target.value))}
            className="w-full h-4 bg-gray-700 rounded-full appearance-none cursor-pointer accent-blue-500
            hover:accent-blue-400"
            />
            <div className="flex justify-between text-gray-500 text-xs font-semibold">
                <span>0mg</span>
                <span>50mg</span>
                <span>100mg (Toxic)</span>
            </div>
        </div>

        {/* INFO BOX */}
        <div className="bg-blue-900/10 border border-blue-500/20 p-6 rounded-xl">
            <h3 className="text-blue-400 font-bold mb-2 flex items-center gap-2 text-sm">
                <IconWind /> Simulation Active
            </h3>
            <p className="text-gray-400 text-xs leading-relaxed">
                The digital twin is currently responding to the selected pharmacological agent. Observe the heart rate
                frequency and color shift in the 3D model.
            </p>
        </div>

        {/* SIMULATE BUTTON */}
        <button onClick={()=> {
            console.log("ðŸ–±ï¸ Simulate button clicked!");
            // alert("Button clicked! Sending message...");
            try {
            window.parent.postMessage({
            type: 'SIMULATE_DRUG',
            data: {
            drug: selectedDrug,
            dosage: dosage,
            // Patient Params (Vitals only)
            hr, sbp, dbp
            }
            }, '*');
            console.log("ðŸ“¤ Message sent to parent.");
            } catch (e) {
            console.error("âŒ Error sending message:", e);
            alert("Error sending message: " + e.message);
            }
            }}
            className="w-full py-4 bg-gradient-to-r from-blue-600 to-cyan-500 rounded-xl font-bold text-white shadow-lg
            hover:shadow-blue-500/25 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center
            justify-center gap-2 uppercase tracking-wider text-sm"
            >
            <IconActivity /> Simulate Drug
        </button>
    </div>
    </div>
    </div>
    );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(
    <App />);
    </script>
    </body>

    </html>